@model IEnumerable<TournamentManager.Models.Tournament>

@{
    ViewData["Title"] = "Tournaments";
}

@if (!User.Identity.IsAuthenticated)
{
    <div class="text-center">
        <h1 class="display-4 page-title-highlight">Public Tournament Listing</h1>
    </div>
}

<div class="container mt-4">
    @if (User.Identity.IsAuthenticated)
    {
        <h2 class="mb-4 page-title-highlight">Tournaments</h2>
    }

    @if (TempData["Error"] != null)
    {
        <div class="alert alert-danger">@TempData["Error"]</div>
    }

    @if (TempData["Success"] != null)
    {
        <div class="alert alert-success">@TempData["Success"]</div>
    }

    @if (!Model.Any())
    {
        <p class="text-muted">No tournaments found.</p>
    }
    else
    {
        <table class="table table-striped table-hover">
            <thead>
                <tr>
                    <th>Name</th>
                    <th>Date</th>
                    <th>Format</th>
                    <th>Status</th>
                    @if (User.Identity.IsAuthenticated)
                    {
                        <th>Organizer</th>
                    }
                    <th>Actions</th>
                </tr>
            </thead>
            <tbody>
                @foreach (var t in Model)
                {
                    <tr>
                        <td>@t.TournamentName</td>
                        <td>@t.TournamentDate.ToString("MMM dd, yyyy")</td>
                        <td>@t.Format</td>
                        <td>@t.Status</td>
                        @if (User.Identity.IsAuthenticated)
                        {
                            <td>@(t.Organizer?.UserName ?? "Unknown")</td>
                            <td>
                                <a asp-action="Details" asp-route-id="@t.TournamentId" class="btn btn-sm btn-outline-primary">
                                    View
                                </a>

                                @* Players can register if open *@
                                @if (t.IsRegistrationOpen && User.IsInRole("Player"))
                                {
                                    <form asp-action="Register" asp-route-tournamentId="@t.TournamentId" method="post" class="d-inline">
                                        <button type="submit" class="btn btn-sm btn-success">
                                            Register
                                        </button>
                                    </form>
                                }

                                @* Organizer/Admin controls *@
                                @if (User.IsInRole("Organizer") || User.IsInRole("Admin"))
                                {
                                    <a asp-action="Edit" asp-route-id="@t.TournamentId" class="btn btn-sm btn-warning">Edit</a>

                                    <form asp-action="SetStatus" asp-route-tournamentId="@t.TournamentId" method="post" class="d-inline">
                                        @if (t.Status == TournamentManager.Models.TournamentStatus.Open)
                                        {
                                            <input type="hidden" name="newStatus" value="@TournamentManager.Models.TournamentStatus.Closed" />
                                            <button type="submit" class="btn btn-sm btn-secondary">Close Reg</button>
                                        }
                                        else if (t.Status == TournamentManager.Models.TournamentStatus.Closed)
                                        {
                                            <input type="hidden" name="newStatus" value="@TournamentManager.Models.TournamentStatus.Open" />
                                            <button type="submit" class="btn btn-sm btn-info">Open Reg</button>
                                        }
                                    </form>
                                }
                                @if (User.IsInRole("Organizer") || User.IsInRole("Admin") || User.IsInRole("Referee"))
                                {
                                    @if (t.Status == TournamentManager.Models.TournamentStatus.InProgress ||
                                                        t.Status == TournamentManager.Models.TournamentStatus.Completed)
                                    {
                                        <a asp-controller="Match"
                                           asp-action="ViewBracket"
                                           asp-route-id="@t.TournamentId"
                                           class="btn btn-sm btn-outline-info">View Bracket</a>
                                    }
                                }
                            </td>
                        } 
                        else
                        {
                            <td>
                                @if (t.Status == TournamentManager.Models.TournamentStatus.InProgress ||
                                                    t.Status == TournamentManager.Models.TournamentStatus.Completed)
                                {
                                    <a asp-controller="Match"
                                       asp-action="ViewBracket"
                                       asp-route-id="@t.TournamentId"
                                       class="btn btn-sm btn-outline-info">View Bracket</a>
                                }
                            </td>
                        }
                    </tr>
                }
            </tbody>
        </table>
    }

    @if (User.IsInRole("Organizer") || User.IsInRole("Admin"))
    {
        <div class="mt-3">
            <a asp-action="Create" class="btn btn-primary">Create Tournament</a>
        </div>
    }

    @if (!User.Identity.IsAuthenticated)
    {
        <br />
        <div class="text-center">
            <h3>
                Log In Now to Join an Open Tournament!
            </h3>
            <h5>
                Tournaments fill up quick! Login now to secure your spot!
            </h5>
            <a class="btn btn-primary" asp-controller="Account" asp-action="Login">Login Now!</a>
            <br /><br />
            <h3>
                Not a Member of Our League?
            </h3>
            <h5>
                Click the "Register Now!" button to join!
            </h5>
            <a class="btn btn-success" asp-controller="Account" asp-action="Register">Register Now!</a>
        </div>
    }
</div>
